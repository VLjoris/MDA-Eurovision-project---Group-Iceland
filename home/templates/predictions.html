{% extends "base.html" %}
{% block content %}
{% load static %}
<title>Mercator projection</title>
		<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="//d3js.org/topojson.v1.min.js"></script>

<div class="container">
        <div class="col-lg-20">

            <div class="table-wrapper-scroll-y" style="height:2000px;padding-top: 30px;">

                  <h2 class="lead mb-0" style= "">Hover a country to see who they'll vote for (green = tele, yelow = jury, purple = both):</h2>

                  <div id="container1" style="padding-top:50">
                  </div>
                  <div class="tooltip"></div>
            </div>
            

              
</div>

<script type="text/javascript">

  var map_data = {{ json_map | safe }}; 
  var country_codes = {{ country_codes | safe }}; 
  var tele = {{ tele | safe }}; 
  var jury = {{ jury | safe }}; 

  function get_to(from){
     return tele.filter((x) => x.from === from)
  }
  function get_to_jury(from){
    return jury.filter((x) => x.from === from)
 }

  //Width and height
  var w = 800;
  var h = 600;
  var tooltip = d3.select("div.tooltip");

  //Define map projection
  var projection = d3.geo.mercator() //utiliser une projection standard pour aplatir les pÃ´les, voir D3 projection plugin
          .center([ 14.5, 48 ]) //comment centrer la carte, longitude, latitude
          .translate([ w/2, h/2 ]) // centrer l'image obtenue dans le svg
          .scale([ w/1 ]); // zoom, plus la valeur est petit plus le zoom est gros 

  //Define path generator
  var path = d3.geo.path()
      .projection(projection);

  //Create SVG
  var svg = d3.select("#container1")
    .append("svg")
    .attr("width", "100%")
    .attr("height", "800")
    .attr("style","border-style: groove;").style("stroke","white");



  //Load in GeoJSON data
  d3.json("", function(json) {
  json = map_data

  
  //Bind data and create one path per GeoJSON feature
  svg.selectAll("path")
  .data(json.features)
  .enter()
  .append("path")
  .attr("d", path)
  .attr("stroke", "rgba(8, 81, 156, 0.2)")
  .attr("fill", "rgba(8, 81, 156, 0.6)")
  .attr("id", d => d.properties.ISO_A2)
  .attr("class", d => country_codes.some(item => item.iso === d.properties.ISO_A2))
  .attr("href", d => '/country/' +d.properties.ISO_A2)
  .on("mouseover",function(d,i){
    d3.select(this).attr("stroke-width",2);
    return tooltip.style("hidden", false).html(d.properties.NAME);
              })
              .on("mousemove",function(d){
                  tooltip.classed("hidden", false)
                        .style("top", (d3.event.pageY) + "px")
                        .style("left", (d3.event.pageX + 10) + "px")
                        .html(d.properties.NAME);

                        var df = get_to(d.properties.ISO_A2)
                        var df_jury = get_to_jury(d.properties.ISO_A2)
                        var to_countries_tele = []
                        var to_countries_jury = []
                        df.forEach(list => {
                            
                                    el = document.getElementById(list.to)
                                    if(el === null ) return
                                    to_countries_tele.push(list.to)
                                    el.setAttribute("fill",  "rgba(3, 255, 0, 0.8)")//green

                            })

                            df_jury.forEach(list => {
       
                               
                                el = document.getElementById(list.to)
                                if(el === null ) return
                                to_countries_jury.push(list.to)
                                el.setAttribute("fill",  "rgba(255, 231, 0, 0.8)")//yelow

                        })
                        var dfs = to_countries_jury.concat(to_countries_tele)
                        
                        var duplicates = dfs.filter((item, index) => dfs.indexOf(item) !== index)

                        duplicates.forEach(c => {
                            el = document.getElementById(c)
                            el.setAttribute("fill","rgba(255, 0, 184, 1)")//purple
                        })
                 


              })
              .on("mouseout",function(d,i){
                
                  tooltip.classed("hidden", true);
                  var eu = document.querySelectorAll('.true');

                  eu.forEach(c => {
                    c.setAttribute("fill","rgba(8, 81, 156, 0.6)")
                  })

              });



  const non_eu = document.querySelectorAll('path.false');

  non_eu.forEach(c => {
    c.classList.toggle('clicked')
  });

  const eu = document.querySelectorAll('.true');

  eu.forEach(c => {
    c.onclick = function(){
        //window.location.pathname = ('/country/' + c.id)
    }

  });
});

 
 


</script>

{% endblock content %}